---
title: "Exercise 11 - Caravans"
output: html_notebook
---

## 0. Setup

Load packages.

```{r packages, warning = FALSE, message= FALSE}
library(tidyverse)
library(tidymodels)
library(caret)
library(ISLR)
library(GGally)
```

## Caravan data

Save Caravan data as a tibble.

```{r caravan_df}
caravan_df <- as_tibble(Caravan)

glimpse(caravan_df)

# Number of NA values
caravan_df %>%
  select(-Purchase) %>%
  summarise_all(~sum(is.na(.))) 

# Minimum values
caravan_df %>%
  select(-Purchase) %>%
  summarise_all(min) 

# Maximum vaues
caravan_df %>%
  select(-Purchase) %>%
  summarise_all(max) 

# Unique values for each variable
caravan_df %>%
  map(~sort(unique(.)))

# Set all variables values subset of 0, 1, 2 to be factors
max_num <- function(x){
  ifelse(is.numeric(x), max(x), 1000)
}

caravan_df <- caravan_df %>%
  mutate_if(~(is.numeric(.) & (max_num(.) <= 2)), ~factor(., levels = sort(unique(.))))

caravan_df %>%
  map(unique)
```

# EDA
Plot charts of variables vs response variable.
```{r eda_boxplots}
# First 10 variables
caravan_df %>%
  select(1:10, "Purchase") %>%
  gather(1:10, key = "variable", value = "value") %>%
  ggplot(aes(variable, value, colour = Purchase)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# 11 to 20 variables (10)
caravan_df %>%
  select(11:20, "Purchase") %>%
  gather(1:10, key = "variable", value = "value") %>%
  ggplot(aes(variable, value, colour = Purchase)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# 20
caravan_df %>%
  select(21:30, "Purchase") %>%
  gather(1:10, key = "variable", value = "value") %>%
  ggplot(aes(variable, value, colour = Purchase)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# 30
caravan_df %>%
  select(31:40, "Purchase") %>%
  gather(1:10, key = "variable", value = "value") %>%
  ggplot(aes(variable, value, colour = Purchase)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# 40
caravan_df %>%
  select(41:50, "Purchase") %>%
  gather(1:10, key = "variable", value = "value") %>%
  ggplot(aes(variable, value, colour = Purchase)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# 50
caravan_df %>%
  select(51:60, "Purchase") %>%
  gather(1:10, key = "variable", value = "value") %>%
  ggplot(aes(variable, value, colour = Purchase)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# 60
caravan_df %>%
  select(61:70, "Purchase") %>%
  gather(1:10, key = "variable", value = "value") %>%
  ggplot(aes(variable, value, colour = Purchase)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# 70
caravan_df %>%
  select(71:80, "Purchase") %>%
  gather(1:10, key = "variable", value = "value") %>%
  ggplot(aes(variable, value, colour = Purchase)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# 80
caravan_df %>%
  select(81:85, "Purchase") %>%
  gather(1:5, key = "variable", value = "value") %>%
  ggplot(aes(variable, value, colour = Purchase)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

The boxplots are only useful up to variable 40.  Of these 40, the variables which look most promising for classifying cases as Purchase = Yes or No are: MRELGE, MOPLMIDD, MHHUUR, MSKA, MOSHOOFD, MOSTYPE, MHKOOP, MZFONDS, PWAPART.  

For variables 50 onwards most of the variable values are zero and so the boxplot is mostly a line at 0 with dots for outliers that are not zero. Do bar charts for these variables instead. Filter out zero values as distort comparison of charts and differences in density of zeros will show up in density of non-zero values anyway.

```{r eda_bars}
# 41 to 50 (40)
caravan_df %>%
  select(41:50, "Purchase") %>%
  gather(1:10, key = "variable", value = "value") %>%
  filter(round(value, 4) != 0) %>%
  ggplot(aes(value, fill = Purchase)) +
  geom_histogram(aes(y = stat(width*density)), position = "dodge") +
  facet_wrap(~ variable) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# 50
caravan_df %>%
  select(51:60, "Purchase") %>%
  gather(1:10, key = "variable", value = "value") %>%
  filter(round(value, 4) != 0) %>%
  ggplot(aes(value, fill = Purchase)) +
  geom_histogram(aes(y = stat(width*density)), position = "dodge") +
  facet_wrap(~ variable) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# 60
caravan_df %>%
  select(61:70, "Purchase") %>%
  gather(1:10, key = "variable", value = "value") %>%
  filter(round(value, 4) != 0) %>%
  ggplot(aes(value, fill = Purchase)) +
  geom_histogram(aes(y = stat(width*density)), position = "dodge") +
  facet_wrap(~ variable) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# 70
caravan_df %>%
  select(71:80, "Purchase") %>%
  gather(1:10, key = "variable", value = "value") %>%
  filter(round(value, 4) != 0) %>%
  ggplot(aes(value, fill = Purchase)) +
  geom_histogram(aes(y = stat(width*density)), position = "dodge") +
  facet_wrap(~ variable) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# 81 to 85
caravan_df %>%
  select(81:85, "Purchase") %>%
  gather(1:5, key = "variable", value = "value") %>%
  filter(round(value, 4) != 0) %>%
  ggplot(aes(value, fill = Purchase)) +
  geom_histogram(aes(y = stat(width*density)), position = "dodge") +
  facet_wrap(~ variable) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

From variables 41 to 85, the followin appear to differentiate between Purchase = Yes and Purchase = No the best: PBESAUT, PVRAAUT, PWABEDR, PWERKT, AVRAAUT, AWERKT, PPERSONG, PGEZONG, PZEILPL.

Select the  variables from 1 to 40  which appear to have the best predictive power and check to see if any correlations between these variables.  

```{r eda_corr}
vars_spread <-
  c(
    "MRELGE",
    "MOPLMIDD",
    "MHHUUR",
    "MSKA",
    "MOSHOOFD",
    "MOSTYPE",
    "MHKOOP",
    "MZFONDS",
    "PWAPART"
  )

# Correlation matrix
caravan_df %>%
  select(one_of(vars_spread)) %>%
  ggcorr(nbreaks=8, palette='RdGy', label=TRUE, label_size=5, label_color='white')
```

There is a clear correlation between MOSHOOFD and MOSTYPE.  It looks like MOSTYPE is a subcategory of MOSHOOFD.  Only include MOSTYPE as this includes more information (wider range of values).

It is less clear that there is an obvious relationship betwen MZFONDS and MHKOOP despite the correlation of -1.

```{r eda_corr_invest}
# Investigate pairs of variables wih high correlations further.
my_bin <-
  function(data,
           mapping,
           ...,
           low = "#132B43",
           high = "#56B1F7") {
    ggplot(data = data, mapping = mapping) +
      geom_bin2d(...) +
      scale_fill_gradient(low = low, high = high)
  }

caravan_df %>%
  select(one_of(c("MOSHOOFD", "MOSTYPE", "MZFONDS", "MHKOOP")), "Purchase") %>%
  ggpairs(columns = 1:4, lower = list(continuous = wrap(
    my_bin, binwidth = c(0.5, 0.5), high = "red"
  )))
```

Repeat for variables 41 to 85
```{r eda_corr_2}
vars_spread_2 <-
  c(
    "BESAUT",
    "PVRAAUT",
    "PWABEDR",
    "PWERKT",
    "AVRAAUT",
    "AWERKT",
    "PPERSONG",
    "PGEZONG",
    "PZEILPL"
  )

# Correlation matrix
caravan_df %>%
  select(one_of(vars_spread_2)) %>%
  ggcorr(nbreaks=8, palette='RdGy', label=TRUE, label_size=5, label_color='white')
```

Investigate pairs AWERKT & PWERKT, and AVRAAUT & PVRAAUT further as have high positive high correlations.
```{r eda}

```

